
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>davidsfriends</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5wcm9qZWN0b3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PGNpcmNsZSBmaWxsPSIjMjU2NUUiIGN4PSI1MCIgY3kPSI1MCIgcj0iNDgiLz48dGV4dCB4PSI1MCUiIHk9IjYwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSI2MCIgZmlsbD0id2hpdGUiPuKUgTwvdGV4dD48L2NpcmNsZT48L3N2Zz4=">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Strict no-scroll */
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom cursor classes */
        .cursor-wait { cursor: wait; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.84.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>
<body class="bg-teal-100 h-screen overflow-hidden">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useEffect, useRef } = React;

        // --- 1. ICONS ---
        const Trash2Icon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
            </svg>
        );
        const XIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
        );

        // --- 2. CONFIGURATION ---
        const SUPABASE_URL = 'https://egqfothiwzcbyajaiftj.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_8PphXvTLOpaqfbRlh_1W7A_ka4j7wXZ'; 
        const TABLE_NAME = 'students';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 3. COMPONENTS ---

        // Background (Chaos Mode Logic)
        const Background = ({ loading = false }) => {
            const canvasRef = useRef(null);
            const loadingRef = useRef(loading);

            useEffect(() => { loadingRef.current = loading; }, [loading]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;

                let width, height, particles = [], animationFrameId;
                let mouse = { x: -999, y: -999 };
                const BASE_COLOR = `rgba(147, 51, 234, 0.6)`; 

                const resizeCanvas = () => {
                    width = canvas.width = window.innerWidth;
                    height = canvas.height = window.innerHeight;
                };

                const createParticles = () => {
                    particles = [];
                    const count = Math.floor((width * height) / 7000); 
                    for (let i = 0; i < count; i++) {
                        particles.push({
                            x: Math.random() * width,
                            y: Math.random() * height,
                            radius: Math.random() * 2.0 + 1.0, 
                            vx: (Math.random() - 0.5) * 0.4, 
                            vy: (Math.random() - 0.5) * 0.4,
                            color: BASE_COLOR,
                            hue: Math.random() * 360, 
                        });
                    }
                };

                const draw = () => {
                    ctx.clearRect(0, 0, width, height);
                    const connectionDistance = 150; 
                    const isLoading = loadingRef.current;

                    particles.forEach((p, i) => {
                        // --- MOVEMENT LOGIC ---
                        if (isLoading) {
                            // SUPER FAST RAINBOW CHAOS: Teleport randomly
                            p.x = Math.random() * width;
                            p.y = Math.random() * height;
                            p.hue = Math.random() * 360;
                        } else {
                            // NORMAL MODE
                            p.x += p.vx; p.y += p.vy;
                            if (p.x < 0 || p.x > width) p.vx *= -1;
                            if (p.y < 0 || p.y > height) p.vy *= -1;

                            const dx_mouse = p.x - mouse.x;
                            const dy_mouse = p.y - mouse.y;
                            const dist_mouse = Math.sqrt(dx_mouse * dx_mouse + dy_mouse * dy_mouse);
                            if (dist_mouse < connectionDistance) {
                                const force = 0.05 * (1 - dist_mouse / connectionDistance);
                                p.x += dx_mouse * force; p.y += dy_mouse * force; 
                            }
                        }

                        // --- DRAWING LOGIC ---
                        let currentColor = BASE_COLOR;
                        if (isLoading) {
                            currentColor = `hsla(${p.hue}, 100%, 60%, 1)`; 
                        } 
                        ctx.fillStyle = currentColor;

                        for (let j = i + 1; j < particles.length; j++) {
                            const p2 = particles[j];
                            const dx = p.x - p2.x;
                            const dy = p.y - p2.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < connectionDistance) {
                                const opacity = 1 - (dist / connectionDistance); 
                                ctx.beginPath();
                                if (isLoading) {
                                    // Lines flash wildly
                                    const lineHue = Math.random() * 360;
                                    ctx.strokeStyle = `hsla(${lineHue}, 100%, 50%, ${opacity})`;
                                    ctx.lineWidth = 2; 
                                } else {
                                    ctx.strokeStyle = `rgba(147, 51, 234, ${opacity * 0.3})`;
                                    ctx.lineWidth = 0.8; 
                                }
                                ctx.moveTo(p.x, p.y);
                                ctx.lineTo(p2.x, p2.y);
                                ctx.stroke();
                            }
                        }
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2, false);
                        ctx.fill();
                    });
                    animationFrameId = requestAnimationFrame(draw);
                };

                resizeCanvas();
                createParticles();
                draw();

                window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
                document.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; });
                document.addEventListener('touchmove', (e) => { 
                    if (e.touches.length > 0) { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; }
                }, { passive: true });

                return () => cancelAnimationFrame(animationFrameId);
            }, []);

            return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full z-0 opacity-70 pointer-events-none" />;
        };

        // AuthButton
        const AuthButton = ({ studentIdentity, onClick }) => {
            const isLoggedIn = !!studentIdentity;
            const name = studentIdentity?.first_name || 'Student';

            return (
                <button
                    onClick={onClick}
                    // Reduced padding to px-3 py-1.5 to be slightly smaller
                    className={`fixed top-4 right-4 text-sm font-semibold px-3 py-1.5 rounded-full shadow-lg transition duration-150 ease-in-out cursor-pointer hover:shadow-xl z-50 ${
                        isLoggedIn ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-blue-600 text-white hover:bg-blue-700'
                    }`}
                >
                    {isLoggedIn ? `Log Out (${name})` : 'Sign In'}
                </button>
            );
        };

        // RegistrationForm (CLEAN VERSION - NO AI FETCH)
        const RegistrationForm = ({ studentIdentity, onNavigateToDelete, onLoadingChange }) => {
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);

            const handleSubmit = async (event) => {
                event.preventDefault();
                setLoading(true);
                setMessage(null);

                const formData = new FormData(event.currentTarget);
                const studentId = formData.get('student-id');
                const fullName = formData.get('full-name').trim();
                const schoolEmail = formData.get('school-email');
                const gradeLevel = formData.get('grade-level');

                // 1. CHECK FOR EXISTING REGISTRATION
                try {
                    const { data: existingUser } = await supabaseClient
                        .from(TABLE_NAME)
                        .select('student_id')
                        .eq('student_id', studentId)
                        .maybeSingle();

                    if (existingUser) {
                        setLoading(false);
                        setMessage({ text: "Error: You are already registered!", type: 'error' });
                        return;
                    }
                } catch (err) { console.error(err); }

                // Start Chaos Animation
                if (onLoadingChange) onLoadingChange(true);

                const nameParts = fullName.split(/\s+/).filter(p => p.length > 0);
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                // 2. SAVE TO SUPABASE IMMEDIATELY
                // We let the Database Trigger handle the AI generation in the background.
                const { error } = await supabaseClient.from(TABLE_NAME).insert([{
                    student_id: studentId,
                    first_name: firstName,
                    last_name: lastName,
                    school_email: schoolEmail,
                    grade_level: gradeLevel,
                    lol: "AI is generating your friendship status..." 
                }]);

                // Small delay just so the user sees the button click register visually
                await new Promise(resolve => setTimeout(resolve, 800));

                setLoading(false);
                if (onLoadingChange) onLoadingChange(false);

                if (error) {
                    let errorMessage = 'Error: Submission failed.';
                    if (error.code === '23505') errorMessage = "Error: You are already registered!";
                    setMessage({ text: errorMessage, type: 'error' });
                } else {
                    setMessage({ text: 'Registration successful!you can now sign in pookie.', type: 'success' });
                    event.target.reset();
                    setTimeout(() => setMessage(null), 10000);
                }
            };

            return (
                // Reduced padding p-6
                <div className="bg-white p-6 rounded-xl shadow-2xl transition-all duration-300 ease-out">
                    <div className="mb-6 text-center">
                        <h1 className="text-3xl font-bold text-blue-600">Hello my friends sign Here!</h1>
                    </div>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Student ID (6 Digits)</label>
                            <input type="text" name="student-id" className="mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border text-gray-900" placeholder="123456" required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">First and Last Name</label>
                            <input type="text" name="full-name" className="mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border text-gray-900" placeholder="Jane Doe" required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">School Email</label>
                            <input type="email" name="school-email" className="mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border text-gray-900" placeholder="jane.doe@school.edu" required />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Current Grade Level</label>
                            <select name="grade-level" required className="mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border text-gray-900" defaultValue="">
                                <option value="">-- Select Grade --</option>
                                <option value="K">Kindergarten</option>
                                {[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}{i+1===1?'st':i+1===2?'nd':i+1===3?'rd':'th'} Grade</option>)}
                            </select>
                        </div>
                        <button type="submit" disabled={loading} className="flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white shadow-lg hover:bg-blue-700 disabled:opacity-50">
                            {loading ? 'Submitting...' : 'Submit'}
                        </button>
                        {message && (
                            <div className={`text-sm text-center font-medium animate-fade-in-up ${message.type === 'success' ? 'text-green-700' : 'text-red-600'}`}>
                                {message.text}
                            </div>
                        )}
                        <div className="mt-4 pt-4 border-t border-gray-200 text-center">
                            <p className="text-sm text-gray-600">If you are already in my database, click the Sign In button in the top right corner.</p>
                        </div>
                    </form>
                    {studentIdentity && (
                        <div className="mt-6 pt-4 border-t border-gray-200">
                            <button onClick={onNavigateToDelete} className="flex w-full justify-center rounded-md border-2 border-blue-600 bg-white py-2 px-4 text-sm font-medium text-blue-600 hover:bg-blue-50">Go to Friendship Management</button>
                        </div>
                    )}
                </div>
            );
        };

        // AccountManagement (Renamed, Updated Text)
        const AccountManagement = ({ studentIdentity, onBack, onOpenDeleteModal }) => {
            return (
                // Reduced padding p-6
                <div className="bg-white p-6 rounded-xl shadow-2xl">
                    <div className="mb-6 text-center">
                        <div className="flex justify-center mb-4"><Trash2Icon className="w-16 h-16 text-red-500" /></div>
                        <h1 className="text-3xl font-bold text-red-600">Friendship Management</h1>
                        <p className="text-gray-600 mt-2">Manage your friendship here.</p>
                    </div>
                    <button onClick={onOpenDeleteModal} className="flex w-full justify-center rounded-md border border-transparent bg-red-600 py-3 px-4 text-sm font-medium text-white shadow-lg hover:bg-red-700">Remove Friendship</button>
                    <div className="mt-6 pt-4 border-t border-gray-200">
                        <button onClick={onBack} className="flex w-full justify-center rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Back to Registration</button>
                    </div>
                </div>
            );
        };

        // LoginModal
        const LoginModal = ({ onClose, onSuccess }) => {
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            const inputRef = useRef(null);

            useEffect(() => { if(inputRef.current) inputRef.current.focus(); }, []);

            const handleSubmit = async (event) => {
                event.preventDefault();
                const studentId = event.target['modal-student-id'].value.trim();
                if (!studentId) { setErrorMsg('Please enter your Student ID.'); return; }
                setLoading(true); setErrorMsg(null);

                const { data: students, error } = await supabaseClient
                    .from(TABLE_NAME).select('student_id, first_name, last_name, lol').eq('student_id', studentId).limit(1);

                if (error) setErrorMsg('Database error.');
                else if (students && students.length === 1) onSuccess(students[0]);
                else setErrorMsg('Student ID not found. Please register first.');
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-gray-50 p-8 rounded-xl shadow-2xl w-full max-w-sm relative animate-fade-in-up">
                        <button onClick={onClose} className="absolute top-3 right-3 text-gray-500 hover:text-gray-800"><XIcon className="w-6 h-6" /></button>
                        <div className="mb-6 text-center"><h2 className="text-2xl font-bold text-gray-800 mb-1">Student Sign In</h2></div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input ref={inputRef} type="text" name="modal-student-id" className="block w-full rounded-md border-gray-300 bg-white shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 border text-gray-900" placeholder="Your 6-digit ID" required />
                            <button type="submit" disabled={loading} className="flex w-full justify-center rounded-md border border-transparent bg-blue-500 py-3 px-4 text-sm font-medium text-white shadow-lg hover:bg-blue-600 disabled:opacity-50">{loading ? 'Validating...' : 'You can sign in!'}</button>
                            {errorMsg && <div className="text-sm text-center text-red-600 font-medium mt-2">{errorMsg}</div>}
                        </form>
                    </div>
                </div>
            );
        };

        // DeleteModal (Updated Text)
        const DeleteModal = ({ studentIdentity, onClose, onSuccess }) => {
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);

            const handleSubmit = async (event) => {
                event.preventDefault();
                const enteredId = event.target['confirm-delete-student-id'].value.trim();
                const enteredFullName = event.target['confirm-delete-full-name'].value.trim();
                
                const nameParts = enteredFullName.split(/\s+/);
                const first = nameParts[0] || ''; const last = nameParts.slice(1).join(' ') || '';
                
                if (enteredId !== studentIdentity.student_id || first.toLowerCase() !== studentIdentity.first_name.toLowerCase()) {
                     setMessage({ text: 'Error: ID or Name mismatch.', type: 'error' });
                     return;
                }
                
                setLoading(true); setMessage(null);
                const { error } = await supabaseClient.from(TABLE_NAME).delete().eq('student_id', studentIdentity.student_id);
                if(error) {
                    setMessage({ text: 'Deletion failed.', type: 'error' });
                    setLoading(false);
                } else {
                    setMessage({ text: 'Friendship successfully removed.', type: 'success' });
                    setTimeout(onSuccess, 1500);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
                    <div className="bg-gray-50 p-8 rounded-xl shadow-2xl w-full max-w-sm relative animate-fade-in-up">
                        <button onClick={onClose} className="absolute top-3 right-3 text-gray-500 hover:text-gray-800"><XIcon className="w-6 h-6" /></button>
                        <h2 className="text-2xl font-bold text-red-700 mb-6 text-center">Remove Friendship</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" name="confirm-delete-student-id" className="block w-full p-3 border rounded" placeholder="Confirm Student ID" required />
                            <input type="text" name="confirm-delete-full-name" className="block w-full p-3 border rounded" placeholder="Confirm First and Last Name" required />
                            <button type="submit" disabled={loading} className="w-full bg-red-600 text-white p-3 rounded hover:bg-red-700">{loading ? 'Removing...' : 'Remove Friendship'}</button>
                            {message && <div className={`text-center ${message.type === 'success' ? 'text-green-700' : 'text-red-600'}`}>{message.text}</div>}
                        </form>
                    </div>
                </div>
            );
        };

        // App
        const App = () => {
            const [studentIdentity, setStudentIdentity] = useState(null);
            const [view, setView] = useState('form');
            const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [isBackgroundLoading, setIsBackgroundLoading] = useState(false);

            useEffect(() => {
                if (!studentIdentity && view === 'delete') {
                    setView('form');
                }
            }, [studentIdentity, view]);

            const handleLoginSuccess = (identity) => {
                setStudentIdentity(identity);
                setIsLoginModalOpen(false);
                setView('form');
            };

            const handleDeleteSuccess = () => {
                setStudentIdentity(null);
                setIsDeleteModalOpen(false);
                setView('form');
            };

            return (
                // Centered, no scroll
                <div className="min-h-screen w-full flex flex-col justify-center items-center relative overflow-hidden">
                    <Background loading={isBackgroundLoading} />
                    <AuthButton studentIdentity={studentIdentity} onClick={() => studentIdentity ? setStudentIdentity(null) : setIsLoginModalOpen(true)} />
                    
                    {/* Centered form - max-w-[420px] and mx-auto */}
                    <div className="w-full max-w-[420px] mx-auto relative z-10 px-4 transition-all duration-300">
                        {view === 'form' ? (
                            <RegistrationForm 
                                studentIdentity={studentIdentity} 
                                onNavigateToDelete={() => setView('delete')} 
                                onLoadingChange={setIsBackgroundLoading}
                            />
                        ) : (
                            <AccountManagement studentIdentity={studentIdentity} onBack={() => setView('form')} onOpenDeleteModal={() => setIsDeleteModalOpen(true)} />
                        )}
                    </div>

                    {isLoginModalOpen && <LoginModal onClose={() => setIsLoginModalOpen(false)} onSuccess={handleLoginSuccess} />}
                    {isDeleteModalOpen && studentIdentity && <DeleteModal studentIdentity={studentIdentity} onClose={() => setIsDeleteModalOpen(false)} onSuccess={handleDeleteSuccess} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

