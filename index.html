
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>davidsfriends</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5wcm9qZWN0b3JnLzIwMDAvc3ZnIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PGNpcmNsZSBmaWxsPSIjMjU2M2ViIiBjeD0iNTAiIGN5PSI1MCIgcj0iNDgiLz48dGV4dCB4PSI1MCUiIHk9IjYwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSI2MCIgZmlsbD0id2hpdGUiPuKUgTwvdGV4dD48L2NpcmNsZT48L3N2Zz4=">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden; /* Strict no-scroll */
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); scale: 0.95; }
            to { opacity: 1; transform: translateY(0); scale: 1; }
        }
        /* Glassmorphism utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(20, 184, 166, 0.3); /* Teal tinted border */
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.86.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body class="bg-teal-50 h-screen overflow-hidden selection:bg-teal-200 selection:text-teal-900">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel" data-presets="react,typescript">
        const { useState, useEffect, useRef } = React;

        // --- 1. ICONS (Lucide style) ---
        const Hash = ({ size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>
        );
        const User = ({ size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const Mail = ({ size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
        );
        const GraduationCap = ({ size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
        );
        const ChevronRight = ({ size = 24, strokeWidth = 2, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
        );
        const LogIn = ({ size = 24, strokeWidth = 2 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
        );
        const LogOut = ({ size = 24, strokeWidth = 2 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        );
        const Trash2 = ({ size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        );
        const ArrowLeft = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        );
        const XIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        );
        const AlertTriangle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        );
        const AlertCircle = ({ size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const CheckCircle = ({ size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );

        // --- 2. CONFIGURATION ---
        const SUPABASE_URL = 'https://egqfothiwzcbyajaiftj.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_8PphXvTLOpaqfbRlh_1W7A_ka4j7wXZ'; 
        const TABLE_NAME = 'students';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 3. COMPONENTS ---

        // Background
        const Background = ({ loading }) => {
            const canvasRef = useRef(null);
            const loadingRef = useRef(loading);

            useEffect(() => { loadingRef.current = loading; }, [loading]);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;

                let width, height, animationFrameId;
                let particles = [];
                let mouse = { x: -999, y: -999 };
                const BASE_COLOR = `rgba(13, 148, 136, 0.6)`; 

                const resizeCanvas = () => {
                    width = canvas.width = window.innerWidth;
                    height = canvas.height = window.innerHeight;
                };

                const createParticles = () => {
                    particles = [];
                    const count = Math.floor((width * height) / 8000); 
                    for (let i = 0; i < count; i++) {
                        particles.push({
                            x: Math.random() * width,
                            y: Math.random() * height,
                            radius: Math.random() * 2.5 + 1.0,
                            vx: (Math.random() - 0.5) * 0.3,
                            vy: (Math.random() - 0.5) * 0.3,
                            color: BASE_COLOR,
                            hue: Math.random() * 60 + 150, 
                        });
                    }
                };

                const draw = () => {
                    ctx.clearRect(0, 0, width, height);
                    const connectionDistance = 160;
                    const isLoading = loadingRef.current;

                    particles.forEach((p, i) => {
                        if (isLoading) {
                            p.x = Math.random() * width;
                            p.y = Math.random() * height;
                            p.hue = Math.random() * 360;
                        } else {
                            p.x += p.vx; p.y += p.vy;
                            if (p.x < 0 || p.x > width) p.vx *= -1;
                            if (p.y < 0 || p.y > height) p.vy *= -1;

                            const dx_mouse = p.x - mouse.x;
                            const dy_mouse = p.y - mouse.y;
                            const dist_mouse = Math.sqrt(dx_mouse * dx_mouse + dy_mouse * dy_mouse);
                            if (dist_mouse < connectionDistance) {
                                const force = 0.04 * (1 - dist_mouse / connectionDistance);
                                p.x += dx_mouse * force; p.y += dy_mouse * force; 
                            }
                        }

                        let currentColor = BASE_COLOR;
                        if (isLoading) {
                            currentColor = `hsla(${p.hue}, 100%, 50%, 0.8)`;
                        } 
                        ctx.fillStyle = currentColor;

                        for (let j = i + 1; j < particles.length; j++) {
                            const p2 = particles[j];
                            const dx = p.x - p2.x;
                            const dy = p.y - p2.y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < connectionDistance) {
                                const opacity = 1 - (dist / connectionDistance); 
                                ctx.beginPath();
                                if (isLoading) {
                                    const lineHue = Math.random() * 360;
                                    ctx.strokeStyle = `hsla(${lineHue}, 100%, 50%, ${opacity})`;
                                    ctx.lineWidth = 2; 
                                } else {
                                    ctx.strokeStyle = `rgba(20, 184, 166, ${opacity * 0.45})`;
                                    ctx.lineWidth = 1; 
                                }
                                ctx.moveTo(p.x, p.y);
                                ctx.lineTo(p2.x, p2.y);
                                ctx.stroke();
                            }
                        }
                        
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2, false);
                        ctx.fill();
                    });
                    animationFrameId = requestAnimationFrame(draw);
                };

                resizeCanvas();
                createParticles();
                draw();

                window.addEventListener('resize', () => { resizeCanvas(); createParticles(); });
                document.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; });
                document.addEventListener('touchmove', (e) => { 
                    if (e.touches.length > 0) { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; }
                }, { passive: true });

                return () => cancelAnimationFrame(animationFrameId);
            }, []);

            return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full z-0 pointer-events-none" />;
        };

        // AuthButton
        const AuthButton = ({ studentIdentity, onClick }) => {
            const isLoggedIn = !!studentIdentity;
            const name = studentIdentity?.first_name || 'Student';

            return (
                <button
                    onClick={onClick}
                    className={`fixed top-5 right-5 text-xs font-bold px-4 py-2.5 rounded-full shadow-lg transition-all duration-200 ease-out cursor-pointer hover:shadow-xl hover:-translate-y-0.5 z-50 flex items-center gap-2 border ${
                        isLoggedIn
                        ? 'bg-white text-teal-700 border-teal-100 hover:bg-teal-50'
                        : 'bg-teal-600 text-white border-transparent hover:bg-teal-700'
                    }`}
                >
                    {isLoggedIn ? (
                        <><span>{name}</span><LogOut size={14} strokeWidth={2.5} /></>
                    ) : (
                        <><span>Sign In</span><LogIn size={14} strokeWidth={2.5} /></>
                    )}
                </button>
            );
        };

        // RegistrationForm
        const RegistrationForm = ({ studentIdentity, onNavigateToDelete, onLoadingChange }) => {
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);
            const [emailValue, setEmailValue] = useState('');

            const handleSubmit = async (event) => {
                event.preventDefault();
                setLoading(true);
                setMessage(null);

                const formData = new FormData(event.currentTarget);
                const studentId = formData.get('student-id').trim();
                const fullName = formData.get('full-name').trim();
                const rawEmailInput = formData.get('email-input').trim();
                const gradeLevel = formData.get('grade-level');

                // --- MANUAL VALIDATION ---
                if (!studentId || studentId.length !== 6 || !/^\d+$/.test(studentId)) {
                    setLoading(false);
                    setMessage({ text: "Please enter a valid 6-digit Student ID.", type: 'error' });
                    return;
                }
                if (!fullName) {
                    setLoading(false);
                    setMessage({ text: "Please enter your First and Last Name.", type: 'error' });
                    return;
                }
                if (!rawEmailInput) {
                    setLoading(false);
                    setMessage({ text: "Please enter your School Email.", type: 'error' });
                    return;
                }
                if (!gradeLevel) {
                    setLoading(false);
                    setMessage({ text: "Please select your Grade Level.", type: 'error' });
                    return;
                }
                // -------------------------

                const schoolEmail = rawEmailInput.includes('@') 
                    ? rawEmailInput 
                    : `${rawEmailInput}@masonohioschools.com`;

                try {
                    const { data: existingUsers } = await supabaseClient
                        .from(TABLE_NAME)
                        .select('student_id')
                        .or(`student_id.eq.${studentId},school_email.eq.${schoolEmail}`)
                        .limit(1);

                    if (existingUsers && existingUsers.length > 0) {
                        setLoading(false);
                        setMessage({ text: "You are already registered!", type: 'error' });
                        return;
                    }
                } catch (err) { console.error(err); }

                onLoadingChange(true);

                const nameParts = fullName.split(/\s+/).filter(p => p.length > 0);
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                const supabasePromise = supabaseClient.from(TABLE_NAME).insert([{
                    student_id: studentId,
                    first_name: firstName,
                    last_name: lastName,
                    school_email: schoolEmail,
                    grade_level: gradeLevel,
                }]);

                const delayPromise = new Promise((resolve) => setTimeout(resolve, 2000));
                const [supabaseResult] = await Promise.all([supabasePromise, delayPromise]);
                const { error } = supabaseResult;

                setLoading(false);
                onLoadingChange(false);

                if (error) {
                    let errorMessage = 'Something went wrong.';
                    if (error.code === '23505') errorMessage = "You are already registered!";
                    setMessage({ text: errorMessage, type: 'error' });
                } else {
                    setMessage({ text: 'Registration successful! You can now sign in :) pookie', type: 'success' });
                    event.target.reset();
                    setEmailValue('');
                    setTimeout(() => setMessage(null), 10000);
                }
            };

            return (
                <div className="glass-panel p-8 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.06)] transition-all duration-300 ease-out border-t border-teal-50/60">
                    <div className="mb-8 text-center">
                        <h1 className="text-2xl font-extrabold text-teal-600 tracking-tight">Hello my friends if you want, sign here!</h1>
                    </div>
                    {/* noValidate added */}
                    <form onSubmit={handleSubmit} className="space-y-5" noValidate>
                        <div className="relative group">
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-teal-400">
                                    <Hash size={18} />
                                </div>
                                <input type="text" name="student-id" placeholder="Student ID" autoComplete="username" className="block w-full rounded-xl border-teal-100 bg-teal-50/30 pl-10 pr-4 py-3.5 text-teal-900 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm transition-all duration-200 outline-none border hover:bg-white focus:bg-white placeholder-teal-400/60" required minLength={6} maxLength={6} />
                            </div>
                        </div>
                        <div className="relative group">
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-teal-400">
                                    <User size={18} />
                                </div>
                                <input type="text" name="full-name" placeholder="First and Last Name" autoComplete="name" className="block w-full rounded-xl border-teal-100 bg-teal-50/30 pl-10 pr-4 py-3.5 text-teal-900 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm transition-all duration-200 outline-none border hover:bg-white focus:bg-white placeholder-teal-400/60" required />
                            </div>
                        </div>
                        <div className="relative group">
                            <div className="flex rounded-xl shadow-sm ring-1 ring-inset ring-teal-100 focus-within:ring-2 focus-within:ring-inset focus-within:ring-teal-500 bg-teal-50/30 overflow-hidden transition-all duration-200 hover:ring-teal-200 hover:bg-white focus-within:bg-white">
                                <div className="pl-3 flex items-center pointer-events-none text-teal-400">
                                    <Mail size={18} />
                                </div>
                                <input 
                                    type="text" 
                                    name="email-input" 
                                    placeholder="School Email" 
                                    autoComplete="email" 
                                    className="block flex-1 border-0 bg-transparent py-3.5 pl-2 text-teal-900 placeholder:text-teal-400/60 focus:ring-0 sm:text-sm sm:leading-6 outline-none min-w-0" 
                                    required
                                    value={emailValue}
                                    onChange={(e) => setEmailValue(e.target.value)}
                                />
                                {!emailValue.includes('@') && (
                                    <div className="flex select-none items-center pr-4 text-teal-500/80 sm:text-xs pl-1 font-medium bg-transparent whitespace-nowrap">
                                        @masonohioschools.com
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="relative group">
                            <div className="relative">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-teal-400">
                                    <GraduationCap size={18} />
                                </div>
                                <select name="grade-level" required className="block w-full rounded-xl border-teal-100 bg-teal-50/30 pl-10 pr-10 py-3.5 text-teal-900 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm transition-all duration-200 outline-none border hover:bg-white focus:bg-white appearance-none" defaultValue="">
                                    <option value="" disabled>Select Grade Level</option>
                                    <option value="K">Kindergarten</option>
                                    {[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}{i+1===1?'st':i+1===2?'nd':i+1===3?'rd':'th'} Grade</option>)}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-teal-500">
                                    <svg className="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                </div>
                            </div>
                        </div>
                        <button type="submit" disabled={loading} className="flex w-full justify-center items-center gap-2 rounded-xl bg-teal-600 py-3.5 px-4 text-sm font-bold text-white shadow-lg shadow-teal-500/20 hover:bg-teal-700 hover:shadow-teal-500/30 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2 disabled:opacity-50 disabled:shadow-none transition-all duration-200 transform active:scale-[0.98] mt-2">
                            {loading ? 'Submitting...' : 'Join Now'}
                            {!loading && <ChevronRight size={16} strokeWidth={3} />}
                        </button>
                        {message && (
                            <div className={`flex items-start gap-3 text-sm font-bold p-4 rounded-xl shadow-sm border animate-fade-in-up ${message.type === 'success' ? 'bg-teal-100 text-teal-900 border-teal-200' : 'bg-red-50 text-red-900 border-red-200'}`}>
                                {message.type === 'success' && <CheckCircle className="shrink-0 text-teal-700" size={20} />}
                                <span>{message.text}</span>
                            </div>
                        )}
                        <div className="mt-6 pt-5 border-t border-teal-100 text-center">
                            <p className="text-xs text-teal-600/70 font-medium">Already registered? Click "Sign In" at the top right.</p>
                        </div>
                    </form>
                    {studentIdentity && (
                        <div className="mt-4">
                            <button onClick={onNavigateToDelete} className="flex w-full justify-center rounded-xl border border-teal-200 bg-white py-3 px-4 text-sm font-bold text-teal-700 hover:bg-teal-50 transition-colors duration-200">Manage Friendship Status</button>
                        </div>
                    )}
                </div>
            );
        };

        // AccountManagement
        const AccountManagement = ({ studentIdentity, onBack, onOpenDeleteModal }) => {
            return (
                <div className="glass-panel p-8 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.1)] border-t border-teal-50/60">
                    <div className="mb-8 text-center">
                        <div className="flex justify-center mb-6">
                            <div className="bg-red-50 p-4 rounded-full border border-red-100"><Trash2 className="w-10 h-10 text-red-500" /></div>
                        </div>
                        <h1 className="text-2xl font-extrabold text-teal-900">Friendship Settings</h1>
                        <p className="text-teal-600 mt-2 text-sm font-medium">Manage your data below.</p>
                    </div>
                    <div className="space-y-4">
                        <button onClick={onOpenDeleteModal} className="flex w-full justify-center items-center gap-2 rounded-xl border border-transparent bg-red-500 py-3.5 px-4 text-sm font-bold text-white shadow-lg shadow-red-500/20 hover:bg-red-600 hover:shadow-red-500/30 transition-all duration-200">
                            <Trash2 size={16} /> Remove Friendship
                        </button>
                        <button onClick={onBack} className="flex w-full justify-center items-center gap-2 rounded-xl border border-teal-200 bg-white py-3.5 px-4 text-sm font-bold text-teal-700 shadow-sm hover:bg-teal-50 transition-all duration-200">
                            <ArrowLeft size={16} /> Back to Dashboard
                        </button>
                    </div>
                </div>
            );
        };

        // LoginModal
        const LoginModal = ({ onClose, onSuccess }) => {
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            const inputRef = useRef(null);

            useEffect(() => { if(inputRef.current) inputRef.current.focus(); }, []);

            const handleSubmit = async (event) => {
                event.preventDefault();
                const formData = new FormData(event.currentTarget);
                const studentId = formData.get('modal-student-id').trim();
                
                // Manual validation
                if (!studentId) { setErrorMsg('Please enter your Student ID.'); return; }
                
                setLoading(true); setErrorMsg(null);

                const { data: students, error } = await supabaseClient
                    .from(TABLE_NAME).select('student_id, first_name, last_name, school_email, grade_level').eq('student_id', studentId).limit(1);

                if (error) setErrorMsg('Database error.');
                else if (students && students.length === 1) onSuccess(students[0]);
                else setErrorMsg('Student ID not found. Please register first.');
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-teal-900/40 backdrop-blur-sm flex justify-center items-center z-50 p-4 transition-all duration-300">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm relative animate-fade-in-up border border-teal-100">
                        <button onClick={onClose} className="absolute top-4 right-4 text-teal-400 hover:text-teal-700 bg-teal-50 hover:bg-teal-100 rounded-full p-1 transition-colors"><XIcon className="w-5 h-5" /></button>
                        <div className="mb-8 text-center">
                            <h2 className="text-2xl font-extrabold text-teal-600 mb-2 tracking-tight">Welcome Back!</h2>
                            <p className="text-sm text-teal-600">Enter your ID to sign in</p>
                        </div>
                        {/* noValidate added */}
                        <form onSubmit={handleSubmit} className="space-y-6" noValidate>
                            <div className="relative group">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-teal-400"><Hash size={18} /></div>
                                <input ref={inputRef} type="text" name="modal-student-id" placeholder="Student ID" autoComplete="username" className="block w-full rounded-xl border-teal-100 bg-teal-50/30 pl-10 pr-4 py-3.5 text-teal-900 shadow-sm focus:border-teal-500 focus:ring-teal-500 sm:text-sm transition-all duration-200 outline-none border hover:bg-white focus:bg-white placeholder-teal-400/60" required />
                            </div>
                            <button type="submit" disabled={loading} className="flex w-full justify-center items-center gap-2 rounded-xl bg-teal-600 py-3.5 px-4 text-sm font-bold text-white shadow-lg shadow-teal-500/20 hover:bg-teal-700 hover:shadow-teal-500/30 disabled:opacity-50 transition-all duration-200 transform active:scale-[0.98]">
                                {loading ? 'Validating...' : 'Sign In'}
                                {!loading && <ChevronRight size={16} strokeWidth={3} />}
                            </button>
                            {errorMsg && (
                                <div className="flex items-start gap-3 text-sm font-bold p-4 rounded-xl shadow-sm border border-red-200 bg-red-50 text-red-900 animate-pulse">
                                    <span>{errorMsg}</span>
                                </div>
                            )}
                        </form>
                    </div>
                </div>
            );
        };

        // DeleteModal
        const DeleteModal = ({ studentIdentity, onClose, onSuccess }) => {
            const [loading, setLoading] = useState(false);
            const [message, setMessage] = useState(null);

            const handleSubmit = async (event) => {
                event.preventDefault();
                const formData = new FormData(event.currentTarget);
                const enteredId = formData.get('confirm-delete-student-id').trim();
                const enteredFullName = formData.get('confirm-delete-full-name').trim();
                const nameParts = enteredFullName.split(/\s+/);
                const first = nameParts[0] || '';
                
                if (enteredId !== studentIdentity.student_id || first.toLowerCase() !== studentIdentity.first_name.toLowerCase()) {
                     setMessage({ text: 'Error: ID or Name mismatch.', type: 'error' });
                     return;
                }
                
                setLoading(true); setMessage(null);
                const { error } = await supabaseClient.from(TABLE_NAME).delete().eq('student_id', studentIdentity.student_id);
                if(error) {
                    setMessage({ text: 'Deletion failed.', type: 'error' });
                    setLoading(false);
                } else {
                    setMessage({ text: 'Friendship successfully removed.', type: 'success' });
                    setTimeout(onSuccess, 1500);
                }
            };

            return (
                <div className="fixed inset-0 bg-red-900/30 backdrop-blur-sm flex justify-center items-center z-50 p-4 transition-all duration-300">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm relative animate-fade-in-up border border-white/50">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-full p-1 transition-colors"><XIcon className="w-5 h-5" /></button>
                        <div className="text-center mb-6">
                            <div className="flex justify-center mb-4"><div className="bg-red-50 p-3 rounded-full"><AlertTriangle className="w-8 h-8 text-red-500" /></div></div>
                            <h2 className="text-2xl font-extrabold text-gray-600 tracking-tight">Confirm Removal</h2>
                            <p className="text-sm text-gray-500 mt-2">This action cannot be undone. Please confirm your details.</p>
                        </div>
                        {/* noValidate added */}
                        <form onSubmit={handleSubmit} className="space-y-4" noValidate>
                            <div>
                                <input type="text" name="confirm-delete-student-id" placeholder="Confirm Student ID" className="block w-full p-3.5 border border-gray-200 rounded-xl bg-gray-50/50 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all placeholder-gray-400" required />
                            </div>
                            <div>
                                <input type="text" name="confirm-delete-full-name" placeholder="Confirm First and Last Name" className="block w-full p-3.5 border border-gray-200 rounded-xl bg-gray-50/50 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all placeholder-gray-400" required />
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-red-600 text-white p-3.5 rounded-xl font-bold shadow-lg shadow-red-500/20 hover:bg-red-700 hover:shadow-red-500/30 disabled:opacity-50 transition-all transform active:scale-[0.98]">
                                {loading ? 'Removing...' : 'Permanently Remove'}
                            </button>
                            {message && (
                                <div className={`flex items-start gap-3 text-sm font-bold p-4 rounded-xl shadow-sm border mt-3 ${message.type === 'success' ? 'bg-teal-100 text-teal-900 border-teal-200' : 'bg-red-50 text-red-900 border-red-200'}`}>
                                    {message.type === 'success' && <CheckCircle className="shrink-0 text-teal-700" size={20} />}
                                    <span>{message.text}</span>
                                </div>
                            )}
                        </form>
                    </div>
                </div>
            );
        };

        // App
        const App = () => {
            const [studentIdentity, setStudentIdentity] = useState(null);
            const [view, setView] = useState('form');
            const [isLoginModalOpen, setIsLoginModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [isBackgroundLoading, setIsBackgroundLoading] = useState(false);

            useEffect(() => {
                if (!studentIdentity && view === 'delete') {
                    setView('form');
                }
            }, [studentIdentity, view]);

            const handleLoginSuccess = (identity) => {
                setStudentIdentity(identity);
                setIsLoginModalOpen(false);
                setView('form');
            };

            const handleDeleteSuccess = () => {
                setStudentIdentity(null);
                setIsDeleteModalOpen(false);
                setView('form');
            };

            return (
                <div className="min-h-screen w-full flex flex-col justify-center items-center relative overflow-hidden">
                    <Background loading={isBackgroundLoading} />
                    <AuthButton studentIdentity={studentIdentity} onClick={() => studentIdentity ? setStudentIdentity(null) : setIsLoginModalOpen(true)} />
                    
                    {/* Centered form - max-w-[450px] and mx-auto */}
                    <div className="w-full max-w-[450px] mx-auto relative z-10 px-4 transition-all duration-300">
                        {view === 'form' ? (
                            <RegistrationForm 
                                studentIdentity={studentIdentity} 
                                onNavigateToDelete={() => setView('delete')} 
                                onLoadingChange={setIsBackgroundLoading}
                            />
                        ) : (
                            <AccountManagement studentIdentity={studentIdentity} onBack={() => setView('form')} onOpenDeleteModal={() => setIsDeleteModalOpen(true)} />
                        )}
                    </div>

                    {isLoginModalOpen && <LoginModal onClose={() => setIsLoginModalOpen(false)} onSuccess={handleLoginSuccess} />}
                    {isDeleteModalOpen && studentIdentity && <DeleteModal studentIdentity={studentIdentity} onClose={() => setIsDeleteModalOpen(false)} onSuccess={handleDeleteSuccess} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
